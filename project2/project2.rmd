---
title: "CITS4009 Computational Data Analysis"
subtitle: "Project 2 - Modelling"

graphics: yes
author: <i>Kaiqi LIANG (23344153) - Briana DAVIES-MORRELL (22734723)</i>
date: "Semester 2, 2022"

output:
  html_document:
    includes:
      before_body: style.html
    number_sections: true
---

```{r, message=FALSE}
library(dplyr)
library(ROCR)

df <- read.csv(file = "AustraliaDataScienceJobs.csv", header = TRUE)
```

```{r, echo=FALSE}
df[df == ""] <- NA

df <- rename(df,
  Number.of.Rater = Companny.Number.of.Rater,
  Career.Opportunities = Company.Career.Opportinities,
  Culture.and.Values = Company.Culture.and.Values,
  Senior.Management = Company.Senior.Management,
  Work.Life.Balance = Company.Work.Life.Balance,
  Friend.Recommendation = Company.Friend.Reccomendation
)

# Drop columns
df <- df[!names(df) %in% c(
    "Country",
    "Job.Descriptions",
    "Url",
    "Company.Founded",
    "Company.CEO.Approval",
    "Number.of.Rater"
)]

# Drop rows that contain NAs in either Job Title or Company Size
df <- df[!is.na(df$Job.Title) & !is.na(df$Company.Size), ]

# Convert _yn columns to logical
skill_columns <- grep("_yn", names(df))
df[skill_columns] <- sapply(df[skill_columns], function(col) {
  as.logical(col)
})

# Convert NAs to Unknown in Company Sector and Company Industry
industry_column <- c("Company.Sector", "Company.Industry")
df[industry_column] <- sapply(df[industry_column], function(column) {
  column[is.na(column)] <- "Unknown"
  column
})

# Impute NAs with median values in the rating columns
rating_columns <- c(
  "Company.Rating",
  "Career.Opportunities",
  "Compensation.and.Benefits",
  "Culture.and.Values",
  "Senior.Management",
  "Work.Life.Balance",
  "Friend.Recommendation"
)
df[rating_columns] <- sapply(df[rating_columns], function(column) {
  na <- is.na(column)
  column[na] <- median(!na)
  column
})
```

Create target column.

```{r}
df$High.Income <- df$Estimate.Base.Salary >= median(df$Estimate.Base.Salary)
df <- df[!names(df) %in% c(
  "High.Estimate",
  "Estimate.Base.Salary",
  "Low.Estimate"
)]
```

Train test split.

```{r}
split <- runif(nrow(df))
test <- df[split >= 0.9, ]
train_all <- df[split < 0.9, ]
```

# Null model
```{r}
null_model <- sum(df$High.Income) / nrow(df)
```

# Single Variable Model
```{r}
variables <- setdiff(colnames(df), "High.Income")
categorical_variables <- variables[
  sapply(train_all[, variables], class) %in% c("factor", "character", "logical")
]
numeric_variables <- variables[
  sapply(train_all[, variables], class) %in% "numeric"
]
```

```{r}
single_variable_prediction <- function(feature_col, output_col, test_col) {
  t <- table(feature_col, output_col)
  pred <- (t[, 2] / (t[, 1] + t[, 2]))[as.character(test_col)]
  pred[is.na(pred)] <- sum(output_col) / length(output_col)
  pred
}
```

```{r}
calc_auc <- function(pred_col, out_col) {
  as.numeric(performance(prediction(pred_col, out_col), "auc")@y.values)
}
```

100-fold cross-validation.

```{r}
for (variable in categorical_variables) {
  aucs <- rep(0, 100)
  for (i in seq(aucs)) {
    split <- runif(nrow(train_all))
    calibration <- train_all[split >= 0.9, ]
    train <- train_all[split < 0.9, ]
    pred_col <- single_variable_prediction(
      train[, variable],
      train$High.Income,
      calibration[, variable]
    )
    aucs[i] <- calc_auc(pred_col, calibration$High.Income)
  }
  mean_auc <- mean(aucs)
  if (mean_auc > 0.7) {
    print(sprintf("%s: %4.3f", variable, mean_auc))
  }
}
```
